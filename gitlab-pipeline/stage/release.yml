#
# Release jobs are based on a common template and come in two flavors:
# - automatic: we use "dependencies" to make sure all previous stages completed
# - and manual: we use "needs" to give the release coordinator the control, for example
#   to publish artifacts in order to early start manual tests or to do it despite errors
#   in previous stages. With great power comes great responsibility.
#

.template_release_board_artifacts:
  tags:
    - mender-qa-worker-generic-light
  # Jobs including this template must define PUBLISH_BOARD_NAME and set up dependencies
  stage: release
  image: debian:12
  script:
    # Publish boards artifacts and sdimg (when not qemu board).
    - aws s3 cp stage-artifacts/${PUBLISH_BOARD_NAME}_release_1_${MENDER_REV}.mender
        s3://mender/${MENDER_REV}/${PUBLISH_BOARD_NAME}/${PUBLISH_BOARD_NAME}_release_1_${MENDER_REV}.mender
    - aws s3api put-object-acl --acl public-read --bucket mender
        --key ${MENDER_REV}/${PUBLISH_BOARD_NAME}/${PUBLISH_BOARD_NAME}_release_1_${MENDER_REV}.mender
    - if ! echo $PUBLISH_BOARD_NAME | grep -q qemu; then
    -   aws s3 cp stage-artifacts/mender-${PUBLISH_BOARD_NAME}_${MENDER_REV}.sdimg.gz
          s3://mender/${MENDER_REV}/${PUBLISH_BOARD_NAME}/mender-${PUBLISH_BOARD_NAME}_${MENDER_REV}.sdimg.gz;
    -   aws s3api put-object-acl --acl public-read --bucket mender
          --key ${MENDER_REV}/${PUBLISH_BOARD_NAME}/mender-${PUBLISH_BOARD_NAME}_${MENDER_REV}.sdimg.gz
    - fi

release:testing-boards:beagleboneblack:manual:
  variables:
    PUBLISH_BOARD_NAME: beagleboneblack
  needs:
    - build:acceptance:beagleboneblack
  when: manual
  only:
    variables:
      - $BUILD_BEAGLEBONEBLACK == "true"
  extends: .template_release_board_artifacts

release:testing-boards:beagleboneblack:automatic:
  variables:
    PUBLISH_BOARD_NAME: beagleboneblack
  dependencies:
    - build:acceptance:beagleboneblack
    - trigger:integration-tests
  only:
    variables:
      - $PUBLISH_RELEASE_AUTOMATIC == "true" && $BUILD_BEAGLEBONEBLACK == "true"
  extends: .template_release_board_artifacts

.publish_helper_functions: &publish_helper_functions |
  # Bash function to check if the string is a final tag
  function is_final_tag () {
    local -r version="$1"
    [[ "${version}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]
  }
  # Bash function to check if the string is a build tag
  function is_build_tag () {
    local -r version="$1"
    [[ "${version}" =~ ^[0-9]+\.[0-9]+\.[0-9]+-build[0-9]+$ ]]
  }
  # Bash function to check if the target binary already exists
  function is_published () {
    local -r bucket="$1"
    local -r path="$2"
    aws s3api head-object --bucket "${bucket}" --key "${path}" >/dev/null 2>&1
  }

.template_release_mender-monitor:
  tags:
    - mender-qa-worker-generic-light
  stage: release
  image: debian:12
  variables:
    S3_BUCKET_NAME: "mender-binaries"
    S3_BUCKET_PATH: "mender-monitor/yocto"
  script:
    - echo "=== mender-monitor $MONITOR_CLIENT_REV ==="
    - echo "Publishing $MONITOR_CLIENT_REV version to s3://$S3_BUCKET_NAME/$S3_BUCKET_PATH/$MONITOR_CLIENT_REV/"
    - aws s3 cp stage-artifacts/mender-monitor-*.tar.gz s3://$S3_BUCKET_NAME/$S3_BUCKET_PATH/$MONITOR_CLIENT_REV/

release:mender-monitor:manual:
  needs:
    - build:mender-monitor:package
  when: manual
  extends: .template_release_mender-monitor

release:mender-monitor:automatic:
  dependencies:
    - build:mender-monitor:package
    - trigger:integration-tests
  only:
    variables:
      - $PUBLISH_RELEASE_AUTOMATIC == "true"
  extends: .template_release_mender-monitor

.template_release_docker_images:client-only:
  tags:
    - mender-qa-worker-generic-light
  stage: release
  image: docker
  services:
    - docker:dind
  before_script:
    # Check correct dind setup
    - docker version
    # Login for private repos
    - docker login -u menderbuildsystem -p ${DOCKER_HUB_PASSWORD}
    - docker login -u ntadm_menderci -p ${REGISTRY_MENDER_IO_PASSWORD} registry.mender.io
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" "$CI_REGISTRY" --password-stdin
  script:
    # Load, tag and push mender-client-* images
    # Historical note,
    # The version here used to be determined by the release_tool, which could distinguish between
    # git repo version and container image version. Today this is kind of messy, as we moved out
    # the backend to a separate repo but we haven't done deep changes in the release process for
    # the rest, and "--version-of" option gives bogus results.
    # TLDR; hardcode to mender-${INTEGRATION_REV} version for the Virtual Devices images
    - |
      version=mender-${INTEGRATION_REV}
      images="mender-client-docker-addons mender-client-qemu mender-client-qemu-rofs"
      for image in $images; do
          docker pull ${GITLAB_REGISTRY_PREFIX}-${image}
          tagged_image=docker.io/mendersoftware/${image}:${version}
          docker tag ${GITLAB_REGISTRY_PREFIX}-${image} ${tagged_image}
          docker push ${tagged_image}
      done

      enterprise_images="mender-monitor-qemu-commercial mender-qemu-rofs-commercial"
      for image in $enterprise_images; do
          docker pull ${GITLAB_REGISTRY_PREFIX}-${image}
          tagged_image=registry.mender.io/mendersoftware/${image}:${version}
          docker tag ${GITLAB_REGISTRY_PREFIX}-${image} ${tagged_image}
          docker push ${tagged_image}
      done

release:virtual-client:manual:
  needs:
    - build:client:qemu
    - build:client:docker
  rules:
    - if: $BUILD_CLIENT == "true"
  when: manual
  extends: .template_release_docker_images:client-only

# This job allows mender repo to publish the related Docker client images on
# merges to master or release branches.
release:virtual-client:automatic:
  dependencies:
    - build:client:qemu
    - build:client:docker
    - trigger:integration-tests
  rules:
    - if: $PUBLISH_DOCKER_CLIENT_IMAGES == "true" && $BUILD_CLIENT == "true"
  extends: .template_release_docker_images:client-only
