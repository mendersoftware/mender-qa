#
# Release jobs are based on a base CI job and come in two flavors:
# - automatic: we use "dependencies" to make sure all previous stages completed
# - and manual: we use "needs" to give the release coordinator the control, for example
#   to publish artifacts in order to early start manual tests or to do it despite errors
#   in previous stages. With great power comes great responsibility.
#

.release:testing-boards:beagleboneblack:
  tags:
    - mender-qa-worker-generic-light
  stage: release
  image: debian:12
  before_script:
    - apt update && apt install -yyq awscli
  script:
    # Publish Mender artifact
    - aws s3 cp stage-artifacts/beagleboneblack_release_1_${MENDER_REV}.mender
        s3://mender/${MENDER_REV}/beagleboneblack/beagleboneblack_release_1_${MENDER_REV}.mender
    - aws s3api put-object-acl --acl public-read --bucket mender
        --key ${MENDER_REV}/beagleboneblack/beagleboneblack_release_1_${MENDER_REV}.mender
    # And disk image
    - aws s3 cp stage-artifacts/mender-beagleboneblack_${MENDER_REV}.sdimg.gz
        s3://mender/${MENDER_REV}/beagleboneblack/mender-beagleboneblack_${MENDER_REV}.sdimg.gz
    - aws s3api put-object-acl --acl public-read --bucket mender
        --key ${MENDER_REV}/beagleboneblack/mender-beagleboneblack_${MENDER_REV}.sdimg.gz

release:testing-boards:beagleboneblack:manual:
  needs:
    - build:acceptance:beagleboneblack
  when: manual
  only:
    variables:
      - $BUILD_BEAGLEBONEBLACK == "true"
  extends: .release:testing-boards:beagleboneblack

release:testing-boards:beagleboneblack:automatic:
  variables:
    PUBLISH_BOARD_NAME: beagleboneblack
  dependencies:
    - build:acceptance:beagleboneblack
    - trigger:integration-tests
  only:
    variables:
      - $PUBLISH_RELEASE_AUTOMATIC == "true" && $BUILD_BEAGLEBONEBLACK == "true"
  extends: .release:testing-boards:beagleboneblack

.release:mender-monitor:
  tags:
    - mender-qa-worker-generic-light
  stage: release
  image: debian:12
  variables:
    S3_BUCKET_NAME: "mender-binaries"
    S3_BUCKET_PATH: "mender-monitor/yocto"
  before_script:
    - apt update && apt install -yyq awscli
  script:
    - echo "=== mender-monitor $MONITOR_CLIENT_REV ==="
    - echo "Publishing $MONITOR_CLIENT_REV version to s3://$S3_BUCKET_NAME/$S3_BUCKET_PATH/$MONITOR_CLIENT_REV/"
    - aws s3 cp stage-artifacts/mender-monitor-*.tar.gz s3://$S3_BUCKET_NAME/$S3_BUCKET_PATH/$MONITOR_CLIENT_REV/

release:mender-monitor:manual:
  needs:
    - build:mender-monitor
  when: manual
  extends: .release:mender-monitor

release:mender-monitor:automatic:
  dependencies:
    - build:mender-monitor
    - trigger:integration-tests
  only:
    variables:
      - $PUBLISH_RELEASE_AUTOMATIC == "true"
  extends: .release:mender-monitor

.release:virtual-client:
  tags:
    - hetzner-amd-beefy
  stage: release
  image: "registry.gitlab.com/northern.tech/mender/mender-test-containers:docker-multiplatform-buildx-v1-master"
  services:
    - name: ${CI_DEPENDENCY_PROXY_DIRECT_GROUP_IMAGE_PREFIX}/docker:28-dind
      alias: docker
  before_script:
    # Check correct dind setup
    - docker version
    # Login for private repos
    - docker login -u menderbuildsystem -p ${DOCKER_HUB_PASSWORD}
    - docker login -u ntadm_menderci -p ${REGISTRY_MENDER_IO_PASSWORD} registry.mender.io
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" "$CI_REGISTRY" --password-stdin
  script:
    # Load, tag and push mender-client-* images
    # Historical note,
    # The version here used to be determined by the release_tool, which could distinguish between
    # git repo version and container image version. Today this is kind of messy, as we moved out
    # the backend to a separate repo but we haven't done deep changes in the release process for
    # the rest, and "--version-of" option gives bogus results.
    # TLDR; hardcode to mender-${INTEGRATION_REV} version for the Virtual Devices images
    - |
      version=mender-${INTEGRATION_REV}
      images="mender-client-docker-addons mender-client-qemu mender-client-qemu-rofs"
      for image in $images; do
          regctl image copy ${GITLAB_REGISTRY_PREFIX}-${image} docker.io/mendersoftware/${image}:${version}
      done

      image="mender-client-qemu-extended"
      if docker pull ${GITLAB_REGISTRY_PREFIX}-${image}; then
          regctl image copy ${GITLAB_REGISTRY_PREFIX}-${image} docker.io/mendersoftware/${image}:${version}
      else
        echo "Skipping 'mender-client-qemu-extended'"
        echo "The meta-mender branch does most likely not contain meta-mender-extended"
      fi

      enterprise_images="mender-monitor-qemu-commercial mender-qemu-rofs-commercial"
      for image in $enterprise_images; do
          regctl image copy ${GITLAB_REGISTRY_PREFIX}-${image} registry.mender.io/mendersoftware/${image}:${version}
      done

release:virtual-client:manual:
  needs:
    - build:client:qemu
    - build:client:docker
  rules:
    - if: $BUILD_CLIENT == "true"
  when: manual
  extends: .release:virtual-client

release:virtual-client:automatic:
  dependencies:
    - build:client:qemu
    - build:client:docker
    - trigger:integration-tests
  rules:
    - if: $PUBLISH_DOCKER_CLIENT_IMAGES == "true" && $BUILD_CLIENT == "true"
  extends: .release:virtual-client
